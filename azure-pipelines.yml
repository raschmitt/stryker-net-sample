trigger:
- master

pool:
  vmImage: 'windows-latest'

steps:
  - task: PowerShell@2
    displayName: 'Get project key'
    inputs:
      targetType: 'inline'
      script: |
        $projectKey = "$(Build.Repository.Name)" -Replace "/","_"

        echo '##vso[task.setvariable variable=one]secondValue'

  - task: PowerShell@2
    inputs:
      targetType: 'inline'
      script: 'echo "${{ variables.projectKey }}"'

  - task: SonarCloudPrepare@1
    displayName: 'Prepare analysis on SonarCloud'
    inputs:
      SonarCloud: 'SonarCloud'
      organization: 'raschmitt'
      scannerMode: 'MSBuild'
      projectKey: "${{ variables.projectKey }}"

  - task: DotNetCoreCLI@2
    displayName: 'Build'
    inputs:
      command: 'build'
      workingDirectory: 'Stryker.Net.Sample'
      
  - task: VSTest@2
    inputs:
      testSelector: 'testAssemblies'
      testAssemblyVer2: |
        **\*Tests.dll
        !**\obj\**
      searchFolder: '$(System.DefaultWorkingDirectory)'
      codeCoverageEnabled: true
      
  - task: SonarCloudAnalyze@1
    displayName: 'Run Code Analysis'

  - task: SonarCloudPublish@1
    displayName: 'Publish Quality Gate Result'
    inputs:
      pollingTimeoutSec: '300'